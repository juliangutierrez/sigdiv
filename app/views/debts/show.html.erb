<div class="position-fixed debt-header">
  <% if notice.present? %>
    <div class="alert alert-success" role="alert">
      <p id="notice" class="mb-0" ><%= notice %></p>
    </div>
  <% end %>

  <h2><strong><%= @debt.code %></strong></h2>
  <h3><%= @debt.name %></h3>

  <nav>
    <div class="nav nav-tabs" id="nav-tab" role="tablist">
      <a class="nav-item nav-link active" id="nav-data-tab" data-toggle="tab" href="#nav-data" role="tab" aria-controls="nav-data" aria-selected="true">Dados</a>
      <a class="nav-item nav-link" id="nav-withdraws-tab" data-toggle="tab" href="#nav-withdraws" role="tab" aria-controls="nav-ops" aria-selected="false">Desembolsos</a>  
      <a class="nav-item nav-link" id="nav-transactions-tab" data-toggle="tab" href="#nav-transactions" role="tab" aria-controls="nav-ops" aria-selected="false">Movimentações</a>
      <a class="nav-item nav-link" id="nav-attachments-tab" data-toggle="tab" href="#nav-attachments" role="tab" aria-controls="nav-ops" aria-selected="false">Anexos</a>
    </div>
  </nav>
</div>
<div class="tab-content debt-content" id="nav-tabContent">
  <div class="tab-pane fade show active" id="nav-data" role="tabpanel" aria-labelledby="nav-data-tab">
    
    <div class="card-group">
      <div class="card">
        <div class="card-header alert-primary"><strong>Valor do contrato</strong></div>
        <div class="card-body">
          <p class="card-text">
            <%= @debt.contract_value %>
            <%= @debt.currency.name %>
          </p>
        </div>
      </div>
      <div class="card">
        <div class="card-header alert-primary"><strong>Data de assinatura</strong></div>
        <div class="card-body">
          <p class="card-text"><%= @debt.signature_date.strftime("%d-%m-%Y") %></p>
        </div>
      </div>
      <div class="card">
        <div class="card-header alert-primary"><strong>Credor</strong></div>
        <div class="card-body">
          <p class="card-text"><%= @debt.creditor.name %></p>      
        </div>
      </div>
      <div class="card">
        <div class="card-header alert-primary"><strong>Agente Financeiro</strong></div>
        <div class="card-body">
          <p class="card-text"><%= @debt.financial_agent.name %></p>      
        </div>
      </div> 
    </div>

    <br>

    <div class="card-group">
      <div class="card">
        <div class="card-header alert-primary"><strong>Prazo de carência</strong></div>
        <div class="card-body">
          <p class="card-text"><%= @debt.grace_period.strftime("%d-%m-%Y") %></p>      
        </div>
      </div>
      <div class="card">
        <div class="card-header alert-primary"><strong>Prazo de amortização</strong></div>
        <div class="card-body">
          <p class="card-text"><%= @debt.amortization_period.strftime("%d-%m-%Y")%></p>
        </div>
      </div>
      <div class="card">
        <div class="card-header alert-primary"><strong>Tipo de amortização</strong></div>
        <div class="card-body">
          <p class="card-text"><%= @debt.amortization_type %></p>      
        </div>
      </div>
      <div class="card">
        <div class="card-header alert-primary"><strong>Periodicidade da amortização</strong></div>
        <div class="card-body">
          <p class="card-text"><%= @debt.amortization_frequency %></p>      
        </div>
      </div> 
    </div>

    <br>

    <div class="card-group">
      <div class="card">
        <div class="card-header alert-primary"><strong>Legislação aplicável</strong></div>
        <div class="card-body">
          <p class="card-text"><%= @debt.applicable_legislation %></p>      
        </div>
      </div>
      <div class="card">
        <div class="card-header alert-primary"><strong>Esfera</strong></div>
        <div class="card-body">
          <p class="card-text"><%= @debt.legislation_level %></p>
        </div>
      </div>  
    </div>

    <br>

    <div class="card-group">
      <div class="card">
        <div class="card-header alert-primary"><strong>Objetivo</strong></div>
        <div class="card-body">
          <p class="card-text"><%= @debt.purpose %></p>      
        </div>
      </div>
    </div>

    <br>

    <div class="card-group">
      <div class="card">
        <div class="card-header alert-primary"><strong>Observações</strong></div>
        <div class="card-body">
          <p class="card-text"><%= @debt.notes %></p>      
        </div>
      </div>
    </div>

  </div>
  <div class="tab-pane fade" id="nav-withdraws" role="tabpanel" aria-labelledby="nav-withdraws-tab">

    <p>
      <strong>Valor do contrato: </strong>
      <%= humanized_money @debt.contract_value_brl %>
    </p>
    <p>
      <strong>Valor do contrato em reais: </strong>
      <%= humanized_money_with_symbol @debt.contract_value_brl %>
    </p>

    <table class="table table-hover debt-withdraws">
      <tbody>      
        <% @debt.withdraws.order(date: 'desc').each do |withdraw| %>
          <tr>
            <td>      
              <span class="badge badge-primary badge-pill">D</span>
              <%= withdraw.date.strftime("%d-%m-%Y") %>
            </td>
            <td class="text-right">
             <%= humanized_money withdraw.value %>
            </td>
          </tr>
        <% end %>
        <tr>
          <td><strong>Saldo devedor</strong></td>
          <td class="text-right"><strong><%= humanized_money @debt.outstanding_balance %></strong></td>
        </tr>
        <tr>
          <td><strong>Saldo devedor em reais</strong></td>
          <td class="text-right"><strong><%= humanized_money_with_symbol @debt.outstanding_balance / @debt.currency.to_brl%></strong></td>
        </tr>
      </tbody>
    </table>

    <p>
      <span class="badge badge-primary badge-pill">D</span> Desembolso
    </p>

    <hr>
    <button type="button" class="btn btn-success" data-toggle="modal" data-target="#withdrawModal">Registrar desembolso</button>

  </div>

  <div class="tab-pane fade" id="nav-transactions" role="tabpanel" aria-labelledby="nav-transactions-tab"></div>
  <div class="tab-pane fade" id="nav-attachments" role="tabpanel" aria-labelledby="nav-attachments-tab"></div>
</div>

<div class="modal fade" id="withdrawModal" tabindex="-1" role="dialog" aria-labelledby="CadastroDesembolso" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">      
    </div>
  </div>
</div>

<script type="text/javascript">
  <% if (request.referrer == debt_url(@debt)) %> 
    $('#nav-ops-tab').tab('show');
  <% end %>

  $('#nav-transactions-tab').on('click', function(){
    $.get('<%= debt_transactions_path(@debt) %>').done(function(data){
      $('#nav-transactions').html(data);
    });
  })

  $('#withdrawModal').on('show.bs.modal', function (e) {
    $.get('<%= new_debt_transaction_path(@debt) %>')
    .done(function( data ) {
      $('#withdrawModal .modal-content').html(data);
      initSubmit();
    });
  })

  function initSubmit(){

    $('button.withdraw-save').on('click', function(e) {
      e.preventDefault();

      $.post('<%= debt_transactions_path(@debt) %>', getWithdraw())
      .done(function(data) {
        $('#withdrawModal').modal('hide');        
      })
      .fail(function(data) {
        $('#withdrawModal .modal-content').html(data.responseText);
        initSubmit();
      });
    });
  }

  function getWithdraw() {
    return { withdraw: { type: $('#withdraw_type').val(),
                         value: $('#withdraw_value').val(),
                         exchange_rate: $('#withdraw_exchange_rate').val(),
                         'date(3i)': $('#withdraw_date_3i').val(),
                         'date(2i)': $('#withdraw_date_2i').val(),
                         'date(1i)': $('#withdraw_date_1i').val() } }
  }
</script>
